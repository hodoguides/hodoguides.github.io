<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HodoGuides · Japan</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root{ --nav-h:72px; --cards-h:150px; --accent:#8f88ff; }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter;
    color:#fff; background:#0e1420; overflow:hidden;
    background-image:
      radial-gradient(ellipse at 50% 40%, #1d2845 0%, #0e1420 60%, #0b0f18 100%),
      radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.18) 0, rgba(255,255,255,0) 100%),
      radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,.14) 0, rgba(255,255,255,0) 100%),
      radial-gradient(1.5px 1.5px at 40% 80%, rgba(255,255,255,.10) 0, rgba(255,255,255,0) 100%);
    background-repeat:no-repeat;
  }

  /* Top bar */
  .topbar{
    position:absolute; left:12px; right:12px; top:12px; z-index:20;
    display:flex; align-items:center; gap:10px;
  }
  .back{
    display:flex; align-items:center; gap:10px;
    background:rgba(255,255,255,.14); padding:10px 14px; border-radius:14px;
    text-decoration:none; color:#fff; backdrop-filter: blur(6px);
  }
  .title{ font-weight:800; font-size:18px; opacity:.95 }

  #map{
    position:absolute; inset:0;
    padding-bottom: calc(var(--cards-h) + 12px);
  }

  /* Cards rail */
  .guides{
    position:absolute; left:0; right:0; bottom:12px; height: var(--cards-h);
    padding: 10px 12px; display:flex; gap:12px; overflow-x:auto; z-index:20; scrollbar-width:none;
  }
  .guides::-webkit-scrollbar{display:none}
  .guide-card{
    position:relative; flex:0 0 240px; height:100%;
    background:#151923; border-radius:16px; overflow:hidden;
    box-shadow:0 8px 24px rgba(0,0,0,.35); text-decoration:none;
    cursor:pointer;
  }
  .guide-card img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
  .guide-card .shade{position:absolute; inset:auto 0 0 0; height:54%;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.78) 60%, rgba(0,0,0,.92) 100%);}
  .guide-card .txt{position:absolute; left:12px; right:12px; bottom:12px; z-index:2; font-size:18px; font-weight:800; line-height:1.25; color:#fff;}

  /* Markers */
  .dot-marker{ width:8px; height:8px; border-radius:50%; background:#fff; border:2px solid rgba(0,0,0,.35); box-shadow:0 0 6px rgba(0,0,0,.35); }
  .photo-marker{ width:38px; height:38px; border-radius:50%; overflow:hidden; border:3px solid #fff; box-shadow:0 0 8px rgba(0,0,0,.45); background:#999; cursor:pointer; }
  .photo-marker img{width:100%; height:100%; object-fit:cover; display:block}

  .popup{
    color:#0d1220; font-family:inherit;
  }
  .popup .name{font-weight:800; margin-bottom:6px;}
  .popup a{display:inline-block; margin-top:6px; padding:8px 12px; border-radius:10px; background:#0e1420; color:#fff; text-decoration:none}
</style>
</head>
<body>

  <div class="topbar">
    <a class="back" href="index.html"><i class="fa-solid fa-chevron-left"></i><span>Explore</span></a>
    <div class="title">Japan</div>
  </div>

  <div id="map"></div>

  <!-- Rail des villes -->
  <div class="guides" id="cardsRail"></div>

<script>
  // --- Map ---
  mapboxgl.accessToken = "pk.eyJ1IjoiZXJpa2FyYW1lbGwiLCJhIjoiY21jbmlteXJuMDBjaDJrc2swbnA0a29wZSJ9.F8aX2alF-PpnqInkyqba8g";
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/erikaramell/cmcnjverq008y01qw6rir46gy",
    projection: "globe",
    center: [135, 33],
    zoom: 3.6
  });
  map.on("style.load", () => map.setFog({}));

  // --- Données villes (coords approx. centre) ---
  const places = [
    {
      id:'okinawa',
      name:'Okinawa (Naha)',
      coords:[127.68, 26.21],
      img:'images/okinawa.jpg',
      fallback:'https://images.unsplash.com/photo-1549692520-acc6669e2f0c?q=80&w=1400&auto=format&fit=crop'
    },
    {
      id:'ishigaki',
      name:'Ishigaki',
      coords:[124.157, 24.344],
      img:'images/ishigaki.jpg',
      fallback:'https://images.unsplash.com/photo-1575882336970-65e2f03f06af?q=80&w=1400&auto=format&fit=crop'
    },
    {
      id:'yonaguni',
      name:'Yonaguni',
      coords:[122.986, 24.468],
      img:'images/yonaguni.jpg',
      fallback:'https://images.unsplash.com/photo-1561291386-5d3e5c4d8f0a?q=80&w=1400&auto=format&fit=crop'
    },
    {
      id:'kyoto',
      name:'Kyoto',
      coords:[135.768, 35.011],
      img:'images/kyoto.jpg',
      fallback:'https://images.unsplash.com/photo-1545569341-9eb8b30979d9?q=80&w=1400&auto=format&fit=crop'
    },
    {
      id:'osaka',
      name:'Osaka',
      coords:[135.502, 34.693],
      img:'images/osaka.jpg',
      fallback:'https://images.unsplash.com/photo-1503891450247-ee5f8ec46dc3?q=80&w=1400&auto=format&fit=crop'
    }
  ];

  // Fit tout le Japon visible
  map.on('load', () => {
    const bounds = new mapboxgl.LngLatBounds();
    places.forEach(p => bounds.extend(p.coords));
    map.fitBounds(bounds, { padding:{top:80, right:40, bottom:parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cards-h'))+30, left:40}, duration:0 });
  });

  // Création des marqueurs (dot + photo au zoom)
  const bundles = [];
  places.forEach(p => {
    const d=document.createElement('div'); d.className='dot-marker';
    const mDot = new mapboxgl.Marker(d,{anchor:'center'}).setLngLat(p.coords).addTo(map);

    const el=document.createElement('div'); el.className='photo-marker';
    const im=document.createElement('img'); im.src=p.img; im.onerror=()=>{im.src=p.fallback}; el.appendChild(im);
    el.title = p.name;
    // popup
    const popup = new mapboxgl.Popup({offset:18, closeButton:true})
      .setHTML(`<div class="popup"><div class="name">${p.name}</div><div>Tap to focus or use the card below.</div><a href="#${p.id}">Open guide</a></div>`);
    const mPhoto = new mapboxgl.Marker(el,{anchor:'center'}).setLngLat(p.coords).setPopup(popup).addTo(map);

    el.addEventListener('click', () => {
      map.flyTo({ center:p.coords, zoom:6.2, speed:0.8, curve:1.4, essential:true });
      mPhoto.togglePopup();
    });

    bundles.push({d: d, p: el});
  });

  // Affichage progressif photo
  const SHOW_PHOTO_AT = 4.5;
  const DOT_MIN=6, DOT_MAX=10, PHOTO_MIN=34, PHOTO_MAX=52;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  function refreshMarkers(){
    const z=map.getZoom();
    bundles.forEach(b=>{
      const show=z>=SHOW_PHOTO_AT;
      b.d.style.display=show?'none':'block';
      b.p.style.display=show?'block':'none';
      const dotSize=clamp(6+(z-0.3)*1.0, DOT_MIN, DOT_MAX);
      const photoSize=clamp(34+(z-SHOW_PHOTO_AT)*3.0, PHOTO_MIN, PHOTO_MAX);
      b.d.style.width=b.d.style.height=dotSize+'px';
      b.p.style.width=b.p.style.height=photoSize+'px';
    });
  }
  map.on('zoom', refreshMarkers);
  map.on('load', refreshMarkers);

  // Rail de cartes — clic => flyTo
  const rail = document.getElementById('cardsRail');
  places.forEach(p=>{
    const card=document.createElement('a');
    card.className='guide-card';
    card.href = `#${p.id}`;
    card.innerHTML = `
      <img src="${p.img}" onerror="this.src='${p.fallback}'" alt="${p.name}">
      <div class="shade"></div>
      <div class="txt">${p.name}</div>`;
    card.addEventListener('click', (e)=>{
      e.preventDefault();
      location.hash = p.id;
      map.flyTo({ center:p.coords, zoom:6.4, speed:0.8, curve:1.4, essential:true });
    });
    rail.appendChild(card);
  });

  // Navigation via #hash
  window.addEventListener('hashchange', ()=>{
    const id = location.hash.replace('#','');
    const target = places.find(x=>x.id===id);
    if(target){
      map.flyTo({ center: target.coords, zoom:6.4, speed:0.9, curve:1.4, essential:true });
    }
  });
  // Si on arrive avec un hash
  if(location.hash){ const id=location.hash.replace('#',''); const t=places.find(x=>x.id===id); if(t) map.once('load',()=>map.flyTo({center:t.coords, zoom:6.4})); }
</script>
</body>
</html>